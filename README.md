# 基于ROS的无人船系统
## 功能1：使用AT9S遥控
使用rosserial连接esp32与工控机，esp可以搭载一些工控机所不能搭载的功能，比如输出控制信号给电子调速器，解析sbus信号实现遥控完全不依赖与网络，测量电池电压等。遥控器使用的是AT9系列。
## 功能2：沿指定路线寻线
基于LOS算法实现
## 功能3：多船协作
使用Apriltag辅助

## 工厂测试

## 技术说明
### LOS部分
实现LOS需要知道船的坐标信息和航向信息，这里并没有使用GPS，使用的是nooploop的uwb室内定位系统，实验环境为特定定位区域内进行，UWB定位技术不具体说明，UWB局部定位精度可达厘米级别，满足控制需求。由此四个UWB基站搭配一个tag得到船的位置信息。对于航向信息采用的方法是多安装一个tag在船上，这样船头尾各一个，求取两个tag在局部定位坐标系内的所在直线的相对于该坐标系的角度即是船在该坐标系中的航向角。rqt目标航线上一些点的坐标，程序进行解析，便可获得LOS中的P(K)与P(K+1)的坐标。至此已经有足够并且正确的数据完成LOS算法的实现。

### 坐标数据部分
在相机和二维码共同组成的坐标系中，ROS里面建立了tf tree对各个坐标以及坐标间的关系信息进行了维护，因此可以直接得到各个坐标系间的信息。在控制过程中目标对接对象应该作为参考坐标系，去控制相机坐标系的欧拉角以及位置偏移达到要求。

### PID控制部分
这里的项目中的控制过程使用的都是PID控制器，其中速度控制采用了PI,对接控制使用了PD控制。在速度控制中，输入误差是实际速度与目标速度的偏差。在对接控制中，输入误差分别为横向坐标偏差，纵向坐标偏差，相对于二维码坐标系的船的航向角和二维码所在位置的偏差。这样就可以把各个动作控制起来了。

### 相机选定
刚开始看上T265相机分辨率高，帧率高且稳定，并且视野广，而选择了它，但是在对偏移位置与角度作为重要参考信息的任务中貌似并不适用，比如传入Apriltag_ros算法中的image_raw是有畸变的鱼眼图像，结算出来的位置和角度信息会因为图像的畸变而不准确。目前还没有尝试将鱼眼相机进行图像矫正再进行二维码定位。所以最终还是用了D435I相机，图像稳定性没有T265那么舒服但是也很足够了。

### 对接实现
对接的实现主要就是控制参数的选定。有两种方案，一是使用两个坐标的偏差作为偏移参考量，在二维码坐标系下相机0°角（即和二维码法线同向）为目标角度；二是使用两个坐标的偏差作为偏移参考量，以相对于二维码坐标系的船的航向角和两船所在位置形成的角度的偏差角度为目标角度（也就是让摄像头始终对准二维码，不让其脱离）。两者都可行，后者更好。